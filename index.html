<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>SimplyApp ‚Äì Inwestycje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#111; --panel:#1c1c1c; --panel2:#222; --border:#444; --text:#fff; --muted:#bbb; --acc:#4caf50;
      --pad:0.75rem; --rad:10px;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font-family:sans-serif; margin:0; padding:2rem; text-align:center}
    h1{margin:0 0 1rem 0}
    h2,h3{margin:1rem 0 .5rem}
    input,button{margin:.35rem; padding:.6rem .9rem; font-size:1rem; border-radius:8px; border:1px solid var(--border); background:#191919; color:var(--text)}
    input::placeholder{color:#777}
    button{background:#2a2a2a; cursor:pointer}
    button:hover{background:#333}
    .btn-primary{background:var(--acc); border-color:#3f9446}
    .btn-danger{background:#b00020; border-color:#8a0019}
    .btn-muted{background:#2a2a2a}
    .row{max-width:1100px; margin:0 auto; text-align:left}
    .card{background:var(--panel2); border:1px solid var(--border); border-radius:var(--rad); padding:var(--pad); margin:1rem 0}
    table{width:100%; border-collapse:collapse; background:var(--panel); border:1px solid var(--border)}
    th,td{border:1px solid var(--border); padding:.6rem .5rem; text-align:left}
    th{background:#2a2a2a}
    #preview{margin:.75rem auto 1rem auto; background:#000}
    #summary{font-weight:bold}
    #dayList ul, #finishedDays ul{list-style:none; padding:0; margin:0}
    #dayList li, #finishedDays li{padding:.5rem; border-bottom:1px solid var(--border); cursor:pointer}
    #dayList li:hover, #finishedDays li:hover{background:#1a1a1a}
    #projectSelection, #app, #montazApp{display:none}

    #progressBar{background:#2a2a2a; border-radius:8px; overflow:hidden; width:100%; height:26px; border:1px solid var(--border)}
    #progressFill{height:100%; width:0%; background:var(--acc); text-align:center; color:#fff; line-height:26px; font-weight:bold}

    .two-cols{display:grid; grid-template-columns:1fr 1fr; gap:1rem}
    @media (max-width:900px){.two-cols{grid-template-columns:1fr}}
    .mt1{margin-top:1rem}
  </style>
</head>
<body>
  <h1>SimplyApp</h1>

  <!-- Wyb√≥r inwestycji -->
  <div id="projectSelection" class="row">
    <div class="card">
      <h2>Wybierz inwestycjƒô</h2>
      <div id="projectList" class="mt1"></div>
      <button class="btn-primary" onclick="showNewProjectForm()">‚ûï Dodaj nowƒÖ inwestycjƒô</button>

      <div id="newProjectForm" class="card" style="display:none; text-align:center">
        <h3>Nowa inwestycja</h3>
        <input type="text" id="projectName" placeholder="Nazwa inwestycji" style="width:280px"><br>
        <h3>Dodaj lampƒô</h3>
        <input type="number" id="lampPower" placeholder="Moc (W)">
        <input type="number" id="lampQty" placeholder="Ilo≈õƒá">
        <button onclick="addLamp()">Dodaj lampƒô</button>
        <div id="lampList" class="mt1"></div>
        <div class="mt1">
          <button class="btn-primary" onclick="saveProject()">Zapisz inwestycjƒô</button>
          <button class="btn-muted" onclick="cancelProject()">Anuluj</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel inwestycji -->
  <div id="app" class="row">
    <div class="card">
      <h2>Inwestycja: <span id="currentProjectName"></span></h2>
      <button class="btn-primary" onclick="openMontaz()">üîß Monta≈º</button>
    </div>

    <div class="two-cols">
      <div class="card">
        <h3>Postƒôp inwestycji</h3>
        <div id="progressBar"><div id="progressFill">0%</div></div>
        <div id="lampPlan" class="mt1"></div>
      </div>

      <div class="card">
        <h3>üìÖ Zako≈Ñczone dni</h3>
        <div id="finishedDays"></div>
      </div>
    </div>

    <div class="card" style="text-align:center">
      <button onclick="backToProjectSelection()">‚¨ÖÔ∏è Zmie≈Ñ inwestycjƒô</button>
    </div>
  </div>

  <!-- Panel monta≈ºu -->
  <div id="montazApp" class="row">
    <div class="card" style="text-align:center">
      <h2>Monta≈º ‚Äì <span id="montazProjectName"></span></h2>
      <div id="preview" style="width:320px;height:220px;"></div>
      <button class="btn-primary" onclick="startScanner()">Skanuj kod QR</button><br>
      <input type="text" id="qrResult" placeholder="Kod QR" readonly style="width:320px"><br>
      <input type="text" id="idInput" placeholder="Wpisz ID">
      <input type="number" id="qtyInput" placeholder="Ilo≈õƒá">
      <input type="number" id="powerInput" placeholder="Moc (W)"><br>
      <button class="btn-primary" onclick="saveEntry()">Zapisz</button>
      <button onclick="exportCSV()">Eksportuj CSV</button>
      <button class="btn-danger" onclick="clearData()">üóëÔ∏è Wyczy≈õƒá dane</button>
      <button onclick="endDay()">üìÖ Zako≈Ñcz dzie≈Ñ</button>
      <button onclick="showRaport()">üìä Raport monta≈ºu</button>
    </div>

    <div class="card">
      <h2 id="summary">Suma ilo≈õci: 0</h2>
      <table id="dataTable">
        <thead>
          <tr>
            <th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>Moc (W)</th><th>GPS</th><th>Czas</th><th>Usu≈Ñ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="two-cols">
      <div class="card">
        <h3>Zapisane dni (archiwum bie≈ºƒÖcej inwestycji)</h3>
        <div id="dayList"></div>
        <div id="totalSum" class="mt1" style="font-weight:bold"></div>
      </div>
      <div class="card">
        <h3>Raport monta≈ºu</h3>
        <div id="raportDiv"></div>
      </div>
    </div>

    <div class="card" style="text-align:center">
      <button onclick="closeMontaz()">‚¨ÖÔ∏è Wr√≥ƒá do inwestycji</button>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // ======= Stan aplikacji =======
    let projects = JSON.parse(localStorage.getItem("projects") || "[]");
    let currentProject = null;
    let tempLamps = [];
    let scanner = null;

    // poka≈º wyb√≥r inwestycji od razu
    document.getElementById("projectSelection").style.display = "block";
    renderProjectList();

    // ======= Projekty (CRUD) =======
    function renderProjectList(){
      const list = document.getElementById("projectList");
      if (!projects.length){
        list.innerHTML = "<p class='muted'>Brak inwestycji. Dodaj pierwszƒÖ.</p>";
        return;
      }
      let html = "<table><thead><tr><th>Nazwa</th><th>Plan (szt.)</th><th>Akcja</th></tr></thead><tbody>";
      projects.forEach((p,i)=>{
        const totalPlan = (p.lamps||[]).reduce((a,b)=>a+(b.qty||0),0);
        html += `<tr>
          <td>${p.name}</td>
          <td>${totalPlan}</td>
          <td><button class="btn-primary" onclick="selectProject(${i})">Wybierz</button></td>
        </tr>`;
      });
      html += "</tbody></table>";
      list.innerHTML = html;
    }

    function showNewProjectForm(){
      tempLamps = [];
      updateLampList();
      document.getElementById("newProjectForm").style.display = "block";
    }
    function addLamp(){
      const power = parseInt(document.getElementById("lampPower").value);
      const qty   = parseInt(document.getElementById("lampQty").value);
      if (!power || !qty){ alert("Podaj poprawnie moc i ilo≈õƒá."); return; }
      tempLamps.push({ power, qty });
      document.getElementById("lampPower").value = "";
      document.getElementById("lampQty").value = "";
      updateLampList();
    }
    function removeLamp(i){
      tempLamps.splice(i,1);
      updateLampList();
    }
    function updateLampList(){
      const c = document.getElementById("lampList");
      if (!tempLamps.length){ c.innerHTML = "<p class='muted'>Brak lamp.</p>"; return; }
      let h = "<table><thead><tr><th>Moc (W)</th><th>Ilo≈õƒá</th><th>Usu≈Ñ</th></tr></thead><tbody>";
      tempLamps.forEach((l,i)=>{
        h += `<tr><td>${l.power}</td><td>${l.qty}</td><td><button onclick="removeLamp(${i})">üóëÔ∏è</button></td></tr>`;
      });
      h += "</tbody></table>";
      c.innerHTML = h;
    }
    function saveProject(){
      const name = (document.getElementById("projectName").value || "").trim();
      if (!name){ alert("Podaj nazwƒô inwestycji."); return; }
      if (!tempLamps.length){ alert("Dodaj przynajmniej jednƒÖ lampƒô."); return; }
      projects.push({ name, lamps: tempLamps });
      localStorage.setItem("projects", JSON.stringify(projects));
      document.getElementById("projectName").value = "";
      tempLamps = [];
      updateLampList();
      document.getElementById("newProjectForm").style.display = "none";
      renderProjectList();
    }
    function cancelProject(){
      document.getElementById("newProjectForm").style.display = "none";
      tempLamps = [];
      updateLampList();
    }
    function selectProject(i){
      currentProject = projects[i];
      localStorage.setItem("currentProject", JSON.stringify(currentProject));
      document.getElementById("projectSelection").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("currentProjectName").textContent = currentProject.name;
      renderLampPlan();
      updateProgress();
      renderFinishedDays();
    }
    function backToProjectSelection(){
      currentProject = null;
      document.getElementById("projectSelection").style.display = "block";
      document.getElementById("app").style.display = "none";
    }

    // ======= Panel inwestycji =======
    function renderLampPlan(){
      const c = document.getElementById("lampPlan");
      if (!currentProject || !currentProject.lamps || !currentProject.lamps.length){
        c.innerHTML = "<p class='muted'>Brak lamp w planie.</p>";
        return;
      }
      const all = getAllScansMerged(); // archiwum + bie≈ºƒÖce
      let h = "<table><thead><tr><th>Moc (W)</th><th>Plan</th><th>Zamontowano</th><th>Pozosta≈Ço</th></tr></thead><tbody>";
      currentProject.lamps.forEach(l=>{
        const inst = all.filter(s=>Number(s.power)===Number(l.power)).reduce((a,b)=>a+(b.qty||0),0);
        const rem  = Math.max(0, (l.qty||0) - inst);
        h += `<tr><td>${l.power}</td><td>${l.qty}</td><td>${inst}</td><td>${rem}</td></tr>`;
      });
      h += "</tbody></table>";
      c.innerHTML = h;
    }

    function updateProgress(){
      if (!currentProject || !currentProject.lamps) return;
      const all = getAllScansMerged(); // archiwum + bie≈ºƒÖce
      const totalPlanned   = currentProject.lamps.reduce((a,b)=>a+(b.qty||0),0);
      const totalInstalled = all.reduce((a,b)=>a+(b.qty||0),0);
      const percent = totalPlanned>0 ? Math.round((totalInstalled/totalPlanned)*100) : 0;
      const bar = document.getElementById("progressFill");
      bar.style.width = percent + "%";
      bar.textContent = percent + "%";
    }

    function renderFinishedDays(){
      const c = document.getElementById("finishedDays");
      if (!currentProject){ c.innerHTML=""; return; }
      const archive = JSON.parse(localStorage.getItem("archive_"+currentProject.name) || "{}");
      if (!Object.keys(archive).length){
        c.innerHTML = "<p class='muted'>Brak zako≈Ñczonych dni.</p>";
        return;
      }
      let h = "<ul>";
      Object.keys(archive).sort().forEach(date=>{
        const rows = archive[date] || [];
        const sum  = rows.reduce((a,b)=>a+(b.qty||0),0);
        h += `<li onclick="showDayInProject('${date}')">${date} ‚Äì ${rows.length} wpis√≥w (Suma: ${sum})</li>`;
      });
      h += "</ul>";
      c.innerHTML = h;
    }

    function showDayInProject(date){
      const c = document.getElementById("finishedDays");
      const archive = JSON.parse(localStorage.getItem("archive_"+currentProject.name) || "{}");
      const rows = archive[date] || [];
      if (!rows.length){ c.innerHTML = "<p class='muted'>Brak danych.</p>"; return; }
      let h = `<h4>Dane z dnia ${date}</h4><table><thead><tr>
                <th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>Moc (W)</th><th>GPS</th><th>Czas</th>
               </tr></thead><tbody>`;
      rows.forEach(r=>{
        h += `<tr><td>${r.qr}</td><td>${r.id}</td><td>${r.qty}</td><td>${r.power||""}</td><td>${r.gps}</td><td>${r.time}</td></tr>`;
      });
      h += "</tbody></table>";
      h += `<div class="mt1" style="text-align:center">
              <button onclick="renderFinishedDays()">‚¨ÖÔ∏è Wr√≥ƒá</button>
              <button onclick="exportDayCSV('${date}')" class="btn-primary">üì§ Eksportuj CSV</button>
            </div>`;
      c.innerHTML = h;
    }

    function exportDayCSV(date){
      const archive = JSON.parse(localStorage.getItem("archive_"+currentProject.name) || "{}");
      const rows = archive[date] || [];
      if (!rows.length){ alert("Brak wpis√≥w dla wybranego dnia."); return; }
      let csv = "Kod QR,ID,Ilo≈õƒá,Moc (W),GPS,Czas\n";
      rows.forEach(r=>{
        csv += `${sanitizeCSV(r.qr)},${sanitizeCSV(r.id)},${r.qty||0},${r.power||""},${sanitizeCSV(r.gps)},${sanitizeCSV(r.time)}\n`;
      });
      downloadCSV(csv, `${currentProject.name}_${date}.csv`);
    }

    // ======= Panel monta≈ºu (skany) =======
    function openMontaz(){
      if (!currentProject){ alert("Wybierz inwestycjƒô."); return; }
      document.getElementById("app").style.display = "none";
      document.getElementById("montazApp").style.display = "block";
      document.getElementById("montazProjectName").textContent = currentProject.name;
      loadScans();
      renderDayList();
      document.getElementById("raportDiv").innerHTML = "";
    }
    function closeMontaz(){
      document.getElementById("montazApp").style.display = "none";
      document.getElementById("app").style.display = "block";
      renderLampPlan();
      updateProgress();
      renderFinishedDays();
    }

    function startScanner(){
      if (typeof Html5Qrcode === "undefined"){
        alert("Biblioteka skanera nie zosta≈Ça za≈Çadowana.");
        return;
      }
      if (!scanner){ scanner = new Html5Qrcode("preview"); }
      const config = { fps:10, qrbox:250 };
      scanner.start({ facingMode:"environment" }, config, (msg)=>{
        document.getElementById("qrResult").value = msg;
        scanner.stop().then(()=>{
          document.getElementById("preview").innerHTML = "";
          scanner = null;
        }).catch(()=>{});
      }).catch(err=>{ alert("B≈ÇƒÖd uruchamiania kamery: " + err); });
    }

    function saveEntry(){
      const qr    = document.getElementById("qrResult").value;
      const id    = document.getElementById("idInput").value;
      const qty   = parseInt(document.getElementById("qtyInput").value) || 0;
      const power = parseInt(document.getElementById("powerInput").value) || 0;
      if (!qr){ alert("Najpierw zeskanuj kod QR."); return; }
      if (!navigator.geolocation){ alert("Twoja przeglƒÖdarka nie obs≈Çuguje geolokalizacji."); return; }

      navigator.geolocation.getCurrentPosition(pos=>{
        const gps  = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        const time = new Date().toLocaleString();
        const row  = { qr, id, qty, power, gps, time };
        const key  = "scans_" + currentProject.name;
        let scans  = JSON.parse(localStorage.getItem(key) || "[]");
        scans.push(row);
        localStorage.setItem(key, JSON.stringify(scans));
        addRow(row, scans.length - 1);
        updateSummary();
      }, err=>alert("Nie uda≈Ço siƒô pobraƒá lokalizacji: " + err.message),
      { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    }

    function addRow(r, i){
      const t = document.querySelector("#dataTable tbody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.qr}</td>
        <td>${r.id}</td>
        <td>${r.qty}</td>
        <td>${r.power || ""}</td>
        <td>${r.gps}</td>
        <td>${r.time}</td>
        <td><button onclick="deleteEntry(${i})">üóëÔ∏è</button></td>
      `;
      t.appendChild(tr);
    }

    function loadScans(){
      const t = document.querySelector("#dataTable tbody");
      t.innerHTML = "";
      const key = "scans_" + currentProject.name;
      let scans = JSON.parse(localStorage.getItem(key) || "[]");
      scans.forEach((r,i)=>addRow(r,i));
      updateSummary();
    }

    function deleteEntry(i){
      const key = "scans_" + currentProject.name;
      let scans = JSON.parse(localStorage.getItem(key) || "[]");
      scans.splice(i,1);
      localStorage.setItem(key, JSON.stringify(scans));
      loadScans();
    }

    function clearData(){
      if (!currentProject) return;
      localStorage.removeItem("scans_" + currentProject.name);
      document.querySelector("#dataTable tbody").innerHTML = "";
      updateSummary();
      document.getElementById("raportDiv").innerHTML = "";
    }

    function updateSummary(){
      const key = "scans_" + currentProject.name;
      let scans = JSON.parse(localStorage.getItem(key) || "[]");
      const sum = scans.reduce((a,r)=>a+(r.qty||0),0);
      document.getElementById("summary").textContent = "Suma ilo≈õci: " + sum;
    }

    function exportCSV(){
      const key = "scans_" + currentProject.name;
      const scans = JSON.parse(localStorage.getItem(key) || "[]");
      let csv = "Kod QR,ID,Ilo≈õƒá,Moc (W),GPS,Czas\n";
      scans.forEach(r=>{
        csv += `${sanitizeCSV(r.qr)},${sanitizeCSV(r.id)},${r.qty||0},${r.power||""},${sanitizeCSV(r.gps)},${sanitizeCSV(r.time)}\n`;
      });
      downloadCSV(csv, `scans_${currentProject.name}.csv`);
    }

    function endDay(){
      const sKey = "scans_" + currentProject.name;
      let scans  = JSON.parse(localStorage.getItem(sKey) || "[]");
      if (!scans.length){ alert("Brak danych do zapisania."); return; }

      const aKey = "archive_" + currentProject.name;
      let archive = JSON.parse(localStorage.getItem(aKey) || "{}");
      const today = new Date().toISOString().slice(0,10);
      if (!archive[today]) archive[today] = [];
      archive[today] = archive[today].concat(scans);
      localStorage.setItem(aKey, JSON.stringify(archive));

      clearData(); // czy≈õci bie≈ºƒÖcy dzie≈Ñ
      alert("Zapisano dzie≈Ñ: " + today);

      renderDayList();      // w panelu monta≈ºu
      renderLampPlan();     // panel inwestycji
      updateProgress();     // panel inwestycji
      renderFinishedDays(); // panel inwestycji
    }

    // ======= Archiwum ‚Äì panel monta≈ºu =======
    function renderDayList(){
      const archive = JSON.parse(localStorage.getItem("archive_"+currentProject.name) || "{}");
      const c = document.getElementById("dayList");
      c.innerHTML = "<ul>";
      if (!Object.keys(archive).length){
        c.innerHTML += "<li class='muted'>Brak zapisanych dni.</li></ul>";
        document.getElementById("totalSum").textContent = "";
        return;
      }
      let total = 0;
      Object.keys(archive).sort().forEach(date=>{
        const dayEntries = archive[date]||[];
        const daySum = dayEntries.reduce((s,r)=>s+(r.qty||0),0);
        total += daySum;
        const li = document.createElement("li");
        li.textContent = `${date} ‚Äì ${dayEntries.length} wpis√≥w (Suma: ${daySum})`;
        li.onclick = ()=> showDayMontaz(date);
        c.querySelector("ul").appendChild(li);
      });
      document.getElementById("totalSum").textContent = "≈ÅƒÖczna suma ilo≈õci: " + total;
    }

    function showDayMontaz(date){
      const archive = JSON.parse(localStorage.getItem("archive_"+currentProject.name) || "{}");
      const rows = archive[date] || [];
      if (!rows.length) return;
      let tableHTML = `
        <h4>Dane z dnia ${date}</h4>
        <table><thead>
          <tr><th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>Moc (W)</th><th>GPS</th><th>Czas</th></tr>
        </thead><tbody>`;
      rows.forEach(r=>{
        tableHTML += `<tr>
          <td>${r.qr}</td><td>${r.id}</td><td>${r.qty}</td><td>${r.power||""}</td><td>${r.gps}</td><td>${r.time}</td>
        </tr>`;
      });
      tableHTML += "</tbody></table>";
      document.getElementById("dayList").innerHTML = tableHTML + `<button class="mt1" onclick="renderDayList()">‚¨ÖÔ∏è Wr√≥ƒá do listy dni</button>`;
    }

    // ======= Raport monta≈ºu ‚Äì panel monta≈ºu =======
    function showRaport(){
      if (!currentProject) return;
      const all = getAllScansMerged(); // archiwum + bie≈ºƒÖce
      if (!all.length){
        document.getElementById("raportDiv").innerHTML = "<p class='muted'>Brak danych do raportu.</p>";
        return;
      }
      let html = "<table><thead><tr><th>Moc (W)</th><th>Planowano</th><th>Zamontowano</th><th>Pozosta≈Ço</th></tr></thead><tbody>";
      let sumPlan=0, sumInst=0, sumRem=0;
      (currentProject.lamps||[]).forEach(l=>{
        const inst = all.filter(s=>Number(s.power)===Number(l.power)).reduce((a,b)=>a+(b.qty||0),0);
        const rem = Math.max(0, (l.qty||0)-inst);
        sumPlan += (l.qty||0);
        sumInst += inst;
        sumRem  += rem;
        html += `<tr><td>${l.power}</td><td>${l.qty}</td><td>${inst}</td><td>${rem}</td></tr>`;
      });
      html += `<tr><td><b>SUMA</b></td><td><b>${sumPlan}</b></td><td><b>${sumInst}</b></td><td><b>${sumRem}</b></td></tr>`;
      html += "</tbody></table>";
      document.getElementById("raportDiv").innerHTML = html;
    }

    // ======= Pomocnicze =======
    function getAllScansMerged(){
      if (!currentProject) return [];
      const sKey = "scans_" + currentProject.name;
      const aKey = "archive_" + currentProject.name;
      const current = JSON.parse(localStorage.getItem(sKey) || "[]");
      const archiveObj = JSON.parse(localStorage.getItem(aKey) || "{}");
      let all = current.slice();
      Object.values(archiveObj).forEach(dayArr=>{
        (dayArr||[]).forEach(x=>all.push(x));
      });
      return all;
    }

    function sanitizeCSV(v){
      if (v===undefined || v===null) return "";
      const s = String(v).replace(/"/g,'""');
      return /[,\"\n]/.test(s) ? `"${s}"` : s;
    }
    function downloadCSV(csv, filename){
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  </script>
</body>
</html>
