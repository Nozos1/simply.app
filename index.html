
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Simply App v9.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <style>
    body { background:#111; color:white; font-family:sans-serif; padding:1em; }
    button { padding: 6px 10px; margin: 4px; }
    table { width:100%; border-collapse:collapse; margin-top:1em; }
    th, td { border:1px solid #555; padding:6px; text-align:center; }
    #qr-reader { width: 300px; margin-top: 1em; display: none; }
  </style>
</head>
<body>
  <h1>Simply App v9.2</h1>
  <button onclick="startScanner()">Uruchom skaner QR</button>
  <div id="qr-reader"></div>
  <br>
  ID: <input id="idInput" placeholder="Wpisz ID">
  <br>
  Ilo≈õƒá: <input id="qtyInput" type="number" value="1" />
  <br>
  <button onclick="saveEntry()">Zapisz</button>
  <button onclick="clearData()" class="danger">Wyczy≈õƒá dane</button>
  <button onclick="exportKML()">Eksportuj mapƒô KML</button>

  <h2>Dane</h2>
  <table id="dataTable">
    <thead><tr><th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>GPS</th><th>Czas</th><th>Usu≈Ñ</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Suma ilo≈õci: <span id="sumQty">0</span></h3>

  <script>
    let entries = JSON.parse(localStorage.getItem('entries') || "[]");
    let coords = null;
    let lastQR = "";

    navigator.geolocation.getCurrentPosition(pos => {
      coords = pos.coords;
    }, err => {
      alert("Brak zgody na lokalizacjƒô.");
    });

    function updateTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      let sum = 0;
      entries.forEach((e, i) => {
        sum += parseInt(e.qty);
        const row = `<tr>
          <td>${e.qr}</td><td>${e.id}</td><td>${e.qty}</td>
          <td>${e.lat.toFixed(5)}, ${e.lon.toFixed(5)}</td>
          <td>${e.time}</td>
          <td><button onclick="removeEntry(${i})">üóëÔ∏è</button></td>
        </tr>`;
        tbody.innerHTML += row;
      });
      document.getElementById("sumQty").innerText = sum;
      localStorage.setItem('entries', JSON.stringify(entries));
    }

    function removeEntry(index) {
      entries.splice(index, 1);
      updateTable();
    }

    function clearData() {
      if (confirm("Na pewno usunƒÖƒá wszystkie dane?")) {
        entries = [];
        updateTable();
      }
    }

    function saveEntry() {
      if (!lastQR || !coords) return alert("Brak QR lub lokalizacji.");
      const id = document.getElementById("idInput").value;
      const qty = document.getElementById("qtyInput").value;
      if (!id || !qty) return alert("Uzupe≈Çnij ID i ilo≈õƒá.");
      const entry = {
        qr: lastQR, id, qty,
        lat: coords.latitude,
        lon: coords.longitude,
        time: new Date().toLocaleString()
      };
      entries.push(entry);
      updateTable();
    }

    function exportKML() {
      const scanned = new Set(entries.map(e => e.id));
      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>
<Style id="zielony"><IconStyle><color>ff00ff00</color><scale>1.1</scale>
<Icon><href>http://maps.google.com/mapfiles/kml/paddle/grn-circle.png</href></Icon></IconStyle></Style>`;

      entries.forEach(e => {
        kml += `\n<Placemark>
<name>${e.id}</name>
<styleUrl>#zielony</styleUrl>
<Point><coordinates>${e.lon},${e.lat}</coordinates></Point>
</Placemark>`;
      });

      kml += "\n</Document>\n</kml>";
      const blob = new Blob([kml], {type: "application/vnd.google-earth.kml+xml"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "mapa_z_pinezkami.kml";
      a.click();
    }

    function startScanner() {
      const readerDiv = document.getElementById("qr-reader");
      readerDiv.style.display = "block";
      const qrScanner = new Html5Qrcode("qr-reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          lastQR = qrCodeMessage;
          alert("Zeskanowano: " + qrCodeMessage);
          qrScanner.stop().then(() => {
            readerDiv.style.display = "none";
          });
        },
        errorMessage => {}
      );
    }

    updateTable();
  </script>
</body>
</html>
