<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>SimplyApp ‚Äì Inwestycje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; padding: 2rem; }
    input, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; background: #222; }
    td, th { border: 1px solid #444; padding: 0.5rem; }
    img.thumb { width: 50px; cursor: pointer; border: 1px solid #555; border-radius: 4px; }
    #preview { margin-bottom: 1rem; }
    #summary { margin-bottom: 1rem; font-weight: bold; }
    #dayList ul, #finishedDays ul { list-style: none; padding-left: 0; }
    #dayList li, #finishedDays li { padding: 0.3rem; border-bottom: 1px solid #333; cursor: pointer; }
    #dayList li:hover, #finishedDays li:hover { background: #222; }
    #projectSelection, #app, #montazApp { display: none; }
  </style>
</head>
<body>
  <h1>SimplyApp</h1>

  <!-- Wyb√≥r inwestycji -->
  <div id="projectSelection">
    <h2>Wybierz inwestycjƒô</h2>
    <div id="projectList"></div>
    <button onclick="showNewProjectForm()">‚ûï Dodaj nowƒÖ inwestycjƒô</button>
    <div id="newProjectForm" style="margin-top:1rem; display:none;">
      <input type="text" id="projectName" placeholder="Nazwa inwestycji"><br><br>
      <h3>Dodaj lampƒô</h3>
      <input type="number" id="lampPower" placeholder="Moc (W)">
      <input type="number" id="lampQty" placeholder="Ilo≈õƒá">
      <button onclick="addLamp()">Dodaj lampƒô</button>
      <div id="lampList" style="margin-top:1rem;"></div>
      <br><button onclick="saveProject()">Zapisz inwestycjƒô</button>
      <button onclick="cancelProject()">Anuluj</button>
    </div>
  </div>

  <!-- Panel inwestycji -->
  <div id="app">
    <h2>Inwestycja: <span id="currentProjectName"></span></h2>
    <button onclick="openMontaz()">üîß Monta≈º</button>
    <div id="progressBar" style="background:#333; border-radius:6px; overflow:hidden; width:80%; margin:1rem auto;">
      <div id="progressFill" style="background:#4caf50; width:0%; height:24px; line-height:24px; color:#fff;">0%</div>
    </div>
    <div id="lampPlan"></div>
    <div id="finishedDays" style="margin-top:2rem; text-align:left;"></div>
    <div id="photoGallery" style="margin-top:2rem; text-align:left;"></div>
    <button onclick="backToProjectSelection()">‚¨ÖÔ∏è Zmie≈Ñ inwestycjƒô</button>
  </div>

  <!-- Panel monta≈ºu -->
  <div id="montazApp">
    <h2>Monta≈º ‚Äì <span id="montazProjectName"></span></h2>
    <div id="preview" style="width:300px;height:200px;margin:0 auto;"></div><br>
    <button onclick="startScanner()">Skanuj kod QR</button><br>
    <input type="text" id="qrResult" placeholder="Kod QR" readonly><br>
    <input type="text" id="idInput" placeholder="Wpisz ID"><br>
    <input type="number" id="qtyInput" placeholder="Ilo≈õƒá"><br>
    <input type="number" id="powerInput" placeholder="Moc (W)"><br>
    <input type="file" id="photoInput" accept="image/*" capture="camera"><br>
    <button id="saveBtn">Zapisz</button>
    <button onclick="exportCSV()">Eksportuj CSV</button>
    <button onclick="exportZIP()">üì¶ Eksportuj ZIP</button>
    <button onclick="clearData()">üóëÔ∏è Wyczy≈õƒá dane</button>
    <button onclick="endDay()">üìÖ Zako≈Ñcz dzie≈Ñ</button>
    <button onclick="showRaport()">üìä Raport monta≈ºu</button>

    <h2 id="summary">Suma ilo≈õci: 0</h2>
    <table id="dataTable">
      <thead><tr><th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>Moc (W)</th><th>GPS</th><th>Czas</th><th>Zdjƒôcie</th><th>Usu≈Ñ</th></tr></thead>
      <tbody></tbody>
    </table>

    <div id="dayList" style="margin-top: 2rem; text-align: left;"></div>
    <div id="totalSum" style="margin-top: 1rem; font-weight: bold;"></div>
    <div id="raportDiv" style="margin-top:2rem;"></div>
    <button onclick="closeMontaz()">‚¨ÖÔ∏è Wr√≥ƒá</button>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // ===== INICJALIZACJA =====
    let projects = JSON.parse(localStorage.getItem("projects") || "[]");
    let currentProject = null;
    let tempLamps = [];
    let scanner;
    let photos = JSON.parse(localStorage.getItem("photos") || "{}");

    document.getElementById("projectSelection").style.display = "block";

    // ===== PROJEKTY =====
    function renderProjectList() {
      const list = document.getElementById("projectList");
      if (projects.length === 0) {
        list.innerHTML = "<p>Brak inwestycji.</p>";
        return;
      }
      let html = "<ul style='list-style:none; padding:0'>";
      projects.forEach((proj, i) => {
        html += `<li><button onclick="selectProject(${i})">${proj.name}</button></li>`;
      });
      html += "</ul>";
      list.innerHTML = html;
    }

    function showNewProjectForm() {
      tempLamps = [];
      updateLampList();
      document.getElementById("newProjectForm").style.display = "block";
    }

    function addLamp() {
      const p = parseInt(document.getElementById("lampPower").value);
      const q = parseInt(document.getElementById("lampQty").value);
      if (!p || !q) return;
      tempLamps.push({ power: p, qty: q });
      document.getElementById("lampPower").value = "";
      document.getElementById("lampQty").value = "";
      updateLampList();
    }

    function removeLamp(i) {
      tempLamps.splice(i, 1);
      updateLampList();
    }

    function updateLampList() {
      const c = document.getElementById("lampList");
      if (tempLamps.length === 0) {
        c.innerHTML = "<p>Brak lamp.</p>";
        return;
      }
      let h = "<table><tr><th>Moc</th><th>Ilo≈õƒá</th><th>Usu≈Ñ</th></tr>";
      tempLamps.forEach((l, i) => {
        h += `<tr><td>${l.power}</td><td>${l.qty}</td><td><button onclick="removeLamp(${i})">üóëÔ∏è</button></td></tr>`;
      });
      h += "</table>";
      c.innerHTML = h;
    }

    function saveProject() {
      const n = document.getElementById("projectName").value.trim();
      if (!n) return;
      if (tempLamps.length === 0) return;
      projects.push({ name: n, lamps: tempLamps });
      localStorage.setItem("projects", JSON.stringify(projects));
      document.getElementById("projectName").value = "";
      tempLamps = [];
      updateLampList();
      document.getElementById("newProjectForm").style.display = "none";
      renderProjectList();
    }

    function cancelProject() {
      document.getElementById("newProjectForm").style.display = "none";
      tempLamps = [];
      updateLampList();
    }

    function selectProject(i) {
      currentProject = projects[i];
      localStorage.setItem("currentProject", JSON.stringify(currentProject));
      document.getElementById("projectSelection").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("currentProjectName").textContent = currentProject.name;
      renderLampPlan();
      updateProgress();
      renderFinishedDays();
      renderPhotoGallery();
    }

    function backToProjectSelection() {
      currentProject = null;
      document.getElementById("projectSelection").style.display = "block";
      document.getElementById("app").style.display = "none";
    }

    function openMontaz() {
      document.getElementById("app").style.display = "none";
      document.getElementById("montazApp").style.display = "block";
      document.getElementById("montazProjectName").textContent = currentProject.name;
      loadScans();
      renderDayList();
    }

    function closeMontaz() {
      document.getElementById("montazApp").style.display = "none";
      document.getElementById("app").style.display = "block";
      renderLampPlan();
      updateProgress();
      renderFinishedDays();
      renderPhotoGallery();
    }

    // ===== LAMPY I POSTƒòP =====
    function renderLampPlan() {
      const c = document.getElementById("lampPlan");
      if (!currentProject || !currentProject.lamps) {
        c.innerHTML = "Brak lamp";
        return;
      }
      let scans = JSON.parse(localStorage.getItem("scans_" + currentProject.name) || "[]");
      let archive = JSON.parse(localStorage.getItem("archive_" + currentProject.name) || "{}");
      let allScans = [...scans];
      Object.values(archive).forEach(day => { allScans = allScans.concat(day) });

      let h = "<table><tr><th>Moc</th><th>Plan</th><th>Zamontowano</th><th>Pozosta≈Ço</th></tr>";
      currentProject.lamps.forEach(l => {
        const inst = allScans.filter(s => s.power === l.power).reduce((a, b) => a + b.qty, 0);
        const rem = l.qty - inst;
        h += `<tr><td>${l.power}</td><td>${l.qty}</td><td>${inst}</td><td>${rem}</td></tr>`;
      });
      h += "</table>";
      c.innerHTML = h;
    }

    function updateProgress() {
      if (!currentProject || !currentProject.lamps) return;
      let scans = JSON.parse(localStorage.getItem("scans_" + currentProject.name) || "[]");
      let archive = JSON.parse(localStorage.getItem("archive_" + currentProject.name) || "{}");
      let allScans = [...scans];
      Object.values(archive).forEach(day => { allScans = allScans.concat(day) });

      const totalPlanned = currentProject.lamps.reduce((a, b) => a + b.qty, 0);
      const totalInstalled = allScans.reduce((a, b) => a + b.qty, 0);
      const percent = totalPlanned > 0 ? Math.round((totalInstalled / totalPlanned) * 100) : 0;
      document.getElementById("progressFill").style.width = percent + "%";
      document.getElementById("progressFill").textContent = percent + "%";
    }

    // ===== ZAKO≈ÉCZONE DNI =====
    function renderFinishedDays() {
      if (!currentProject) return;
      const archive = JSON.parse(localStorage.getItem("archive_" + currentProject.name) || "{}");
      const c = document.getElementById("finishedDays");
      c.innerHTML = "<h3>üìÖ Zako≈Ñczone dni:</h3>";
      if (Object.keys(archive).length === 0) {
        c.innerHTML += "<p>Brak zako≈Ñczonych dni.</p>";
        return;
      }
      const ul = document.createElement("ul");
      for (let d in archive) {
        const dayEntries = archive[d];
        const daySum = dayEntries.reduce((s, r) => s + r.qty, 0);
        const li = document.createElement("li");
        li.textContent = `${d} ‚Äì ${dayEntries.length} wpis√≥w (Suma: ${daySum})`;
        li.onclick = () => showDayInProject(d);
        ul.appendChild(li);
      }
      c.appendChild(ul);
    }

    function showDayInProject(date) {
      const archive = JSON.parse(localStorage.getItem("archive_" + currentProject.name) || "{}");
      let rows = archive[date];
      if (!rows) return;
      let html = `<h3>Dane z dnia ${date}</h3><table style='width:100%; border-collapse:collapse;'>
        <thead><tr><th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>Moc</th><th>GPS</th><th>Czas</th></tr></thead><tbody>`;
      rows.forEach(r => {
        html += `<tr><td>${r.qr}</td><td>${r.id}</td><td>${r.qty}</td><td>${r.power}</td><td>${r.gps}</td><td>${r.time}</td></tr>`;
      });
      html += "</tbody></table>";
      html += `<button onclick="renderFinishedDays()">‚¨ÖÔ∏è Wr√≥ƒá</button> 
               <button onclick="exportDayCSV('${date}')">üì§ Eksportuj CSV</button>`;
      document.getElementById("finishedDays").innerHTML = html;
    }

    function exportDayCSV(date) {
      const archive = JSON.parse(localStorage.getItem("archive_" + currentProject.name) || "{}");
      let rows = archive[date];
      if (!rows) return;
      let csv = "Kod QR,ID,Ilo≈õƒá,Moc (W),GPS,Czas\n";
      rows.forEach(r => { csv += `${r.qr},${r.id},${r.qty},${r.power},${r.gps},${r.time}\n`; });
      const blob = new Blob([csv], { type: "text/csv" });
      saveAs(blob, `${currentProject.name}_${date}.csv`);
    }

    // ===== QR SKANER =====
    function startScanner() {
      if (!scanner) { scanner = new Html5Qrcode("preview"); }
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        msg => {
          document.getElementById("qrResult").value = msg;
          scanner.stop().then(() => {
            document.getElementById("preview").innerHTML = "";
            scanner = null;
          });
        }
      ).catch(e => alert("B≈ÇƒÖd kamery: " + e));
    }

    // ===== ZAPIS WEJ≈öCIA + ZDJƒòCIA =====
    function saveEntry() {
      const qr = document.getElementById("qrResult").value;
      const id = document.getElementById("idInput").value.trim();
      const qty = parseInt(document.getElementById("qtyInput").value) || 0;
      const power = parseInt(document.getElementById("powerInput").value) || 0;
      if (!qr || !id) return alert("Skan QR i ID wymagane");

      const file = document.getElementById("photoInput").files[0];
      const time = new Date().toLocaleString();

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          photos[id] = e.target.result;
          localStorage.setItem("photos", JSON.stringify(photos));
          finishSave(qr, id, qty, power, time, file.name);
        };
        reader.readAsDataURL(file);
      } else {
        finishSave(qr, id, qty, power, time, "");
      }
    }

    function finishSave(qr, id, qty, power, time, photoName) {
      const gps = "";
      const row = { qr, id, qty, power, gps, time, photo: photoName };
      let scans = JSON.parse(localStorage.getItem("scans_" + currentProject.name) || "[]");
      scans.push(row);
      localStorage.setItem("scans_" + currentProject.name, JSON.stringify(scans));
      addRow(row, scans.length - 1);
      updateSummary();
      renderLampPlan();
      updateProgress();
      renderPhotoGallery();

      document.getElementById("qrResult").value = "";
      document.getElementById("idInput").value = "";
      document.getElementById("qtyInput").value = "";
      document.getElementById("powerInput").value = "";
      document.get
