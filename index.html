<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Simply App Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; padding: 2rem; }
    input, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
    td, th { border: 1px solid #333; padding: 0.5rem; }
    #preview { margin-bottom: 1rem; }
    #summary { margin-bottom: 1rem; font-weight: bold; }
    #dayList ul { list-style: none; padding-left: 0; }
    #dayList li { padding: 0.3rem; border-bottom: 1px solid #333; cursor: pointer; }
    #dayList li:hover { background: #222; }
  </style>
</head>
<body>
  <h1>Simply App Online (Supabase)</h1>
  <div id="preview" style="width:300px;height:200px;margin:0 auto;"></div><br>
  <button onclick="startScanner()">Skanuj kod QR</button><br>
  <input type="text" id="qrResult" placeholder="Kod QR" readonly><br>
  <input type="text" id="idInput" placeholder="Wpisz ID"><br>
  <input type="number" id="qtyInput" placeholder="Ilo≈õƒá"><br>
  <button onclick="saveEntry()">Zapisz</button>
  <button onclick="exportCSV()">Eksportuj CSV</button>
  <button onclick="clearData()">Wyczy≈õƒá dane lokalne</button>
  <button onclick="endDay()">Zako≈Ñcz dzie≈Ñ</button>

  <h2 id="summary">Suma ilo≈õci: 0</h2>
  <table id="dataTable">
    <thead><tr><th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>GPS</th><th>Czas</th><th>Usu≈Ñ</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="dayList" style="margin-top: 2rem; text-align: left;"></div>
  <div id="totalSum" style="margin-top: 1rem; font-weight: bold;"></div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // ===== KONFIGURACJA SUPABASE =====
    const SUPABASE_URL = "TUTAJ_WKLEJ_SW√ìJ_URL";
    const SUPABASE_ANON_KEY = "TUTAJ_WKLEJ_SW√ìJ_ANON_KEY";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let data = [];

    window.addEventListener("DOMContentLoaded", async () => {
      await loadEntries();
      await renderDayList();
    });

    async function loadEntries() {
      const { data: entries, error } = await supabaseClient
        .from('entries')
        .select('*')
        .order('id', { ascending: true });
      if (error) {
        alert("B≈ÇƒÖd pobierania danych: " + error.message);
        return;
      }
      data = entries || [];
      renderTable();
      updateSummary();
    }

    function renderTable() {
      const table = document.querySelector("#dataTable tbody");
      table.innerHTML = "";
      data.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.qr}</td>
          <td>${row.custom_id}</td>
          <td>${row.qty}</td>
          <td>${row.gps}</td>
          <td>${row.time}</td>
          <td><button onclick="deleteEntry(${row.id})">üóëÔ∏è</button></td>
        `;
        table.appendChild(tr);
      });
    }

    function updateSummary() {
      const sum = data.reduce((total, row) => total + (row.qty || 0), 0);
      document.getElementById("summary").textContent = "Suma ilo≈õci: " + sum;
    }

    async function saveEntry() {
      const qr = document.getElementById("qrResult").value;
      const custom_id = document.getElementById("idInput").value;
      const qty = parseInt(document.getElementById("qtyInput").value) || 0;
      if (!qr) return alert("Najpierw zeskanuj kod QR.");

      if (!navigator.geolocation) {
        alert("Twoja przeglƒÖdarka nie obs≈Çuguje geolokalizacji.");
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        const gps = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        const time = new Date().toLocaleString();
        const day = new Date().toISOString().slice(0, 10);

        const { error } = await supabaseClient.from('entries').insert([{ qr, custom_id, qty, gps, time, day }]);
        if (error) {
          alert("B≈ÇƒÖd zapisu: " + error.message);
          return;
        }

        await loadEntries();
      }, err => {
        alert("Nie uda≈Ço siƒô pobraƒá lokalizacji: " + err.message);
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }

    async function deleteEntry(id) {
      const { error } = await supabaseClient.from('entries').delete().eq('id', id);
      if (error) {
        alert("B≈ÇƒÖd usuwania: " + error.message);
        return;
      }
      await loadEntries();
    }

    async function endDay() {
      // Liczymy sumƒô dnia
      const today = new Date().toISOString().slice(0, 10);
      const todayEntries = data.filter(row => row.day === today);
      const total_qty = todayEntries.reduce((sum, row) => sum + row.qty, 0);

      // Zapisujemy dzie≈Ñ do tabeli days
      await supabaseClient.from('days').upsert([{ day: today, total_qty }]);

      // Czy≈õcimy wpisy z entries
      for (let entry of todayEntries) {
        await supabaseClient.from('entries').delete().eq('id', entry.id);
      }

      await loadEntries();
      await renderDayList();
    }

    async function renderDayList() {
      const { data: days, error } = await supabaseClient
        .from('days')
        .select('*')
        .order('day', { ascending: true });

      if (error) {
        alert("B≈ÇƒÖd pobierania dni: " + error.message);
        return;
      }

      const container = document.getElementById("dayList");
      container.innerHTML = "<h3>Zapisane dni:</h3>";

      if (!days || days.length === 0) {
        container.innerHTML += "<p>Brak zapisanych dni.</p>";
        document.getElementById("totalSum").textContent = "";
        return;
      }

      const ul = document.createElement("ul");
      let totalSum = 0;

      for (let dayRow of days) {
        totalSum += dayRow.total_qty;
        const li = document.createElement("li");
        li.textContent = `${dayRow.day} ‚Äì suma: ${dayRow.total_qty}`;
        li.onclick = () => showDay(dayRow.day);
        ul.appendChild(li);
      }

      container.appendChild(ul);
      document.getElementById("totalSum").textContent = "≈ÅƒÖczna suma ilo≈õci: " + totalSum;
    }

    async function showDay(day) {
      const { data: entries, error } = await supabaseClient
        .from('entries')
        .select('*')
        .eq('day', day);

      if (error) {
        alert("B≈ÇƒÖd pobierania wpis√≥w: " + error.message);
        return;
      }

      let tableHTML = `
        <h3>Dane z dnia ${day}</h3>
        <table style="width:100%; border-collapse: collapse;">
          <thead><tr><th>Kod QR</th><th>ID</th><th>Ilo≈õƒá</th><th>GPS</th><th>Czas</th></tr></thead>
          <tbody>
      `;

      entries.forEach(row => {
        tableHTML += `
          <tr>
            <td>${row.qr}</td>
            <td>${row.custom_id}</td>
            <td>${row.qty}</td>
            <td>${row.gps}</td>
            <td>${row.time}</td>
          </tr>
        `;
      });

      tableHTML += "</tbody></table>";
      document.getElementById("dayList").innerHTML = tableHTML + '<button onclick="renderDayList()">‚¨ÖÔ∏è Wr√≥ƒá do listy dni</button>';
    }

    function clearData() {
      data = [];
      renderTable();
      updateSummary();
    }

    // Skaner QR ‚Äì jak w v8
    let scanner;
    function startScanner() {
      if (!scanner) {
        scanner = new Html5Qrcode("preview");
      } else {
        scanner.clear().catch(() => {});
      }

      const config = { fps: 10, qrbox: 250, facingMode: { exact: "environment" } };

      scanner.start({ facingMode: "environment" }, config, qrCodeMessage => {
        document.getElementById("qrResult").value = qrCodeMessage;
        scanner.stop().then(() => {
          document.getElementById("preview").innerHTML = "";
        });
      }).catch(err => {
        alert("B≈ÇƒÖd uruchamiania kamery: " + err);
      });
    }
  </script>
</body>
</html>